var NodeGraph={};NodeGraph.ConnectionStyle={},NodeGraph.Utils={},NodeGraph.Camera=class{constructor(e){this.theme=e,this.x=0,this.y=0,this.zoom=1,this.xSmooth=this.x,this.ySmooth=this.y,this.zoomSmooth=this.zoom}update(e){let o=NodeGraph.Utils.lerp;e/=this.theme.cameraSmoothing,this.xSmooth=o(this.xSmooth,this.x,e),this.ySmooth=o(this.ySmooth,this.y,e),this.zoomSmooth=o(this.zoomSmooth,this.zoom,e)}camX(e){return e*this.zoomSmooth-this.xSmooth}camY(e){return e*this.zoomSmooth-this.ySmooth}acamX(e){return(e+this.xSmooth)/this.zoomSmooth}acamY(e){return(e+this.ySmooth)/this.zoomSmooth}needsUpdate(){var e=Math.abs;return .01<e(this.x-this.xSmooth)+e(this.y-this.ySmooth)+e(this.zoom-this.zoomSmooth)}},NodeGraph.Connection=class{constructor(e,o,t){if(null==o||null==t)throw"Cannot create a connection using null plugs!";if(!o.canConnectTo(t))throw"A connection is not valid here!";this.tree=e,this.outputPlug=o,this.inputPlug=t}get connectionColor(){return null==this.outputPlug.type||null==this.outputPlug.type.connectionColor?this.tree.theme.connectionColor:this.outputPlug.type.connectionColor}get connectionEndColor(){if(null==this.outputPlug.type||null==this.outputPlug.type.connectionEndColor)return this.connectionColor;let e=this.outputPlug.type.connectionEndColor(this);return null==e?this.connectionColor:e}render(e){e.lineWidth=this.tree.theme.connectionWidth;let o=this.connectionColor,t=this.connectionEndColor;if(o==t)e.strokeStyle=this.connectionColor;else{let n=this.outputPlug.pos.toScreen(this.tree.camera),i=this.inputPlug.pos.toScreen(this.tree.camera),d=e.createLinearGradient(n.x,n.y,i.x,i.y);d.addColorStop(0,o),d.addColorStop(1,t),e.strokeStyle=d}this.tree.theme.connectionStyle(this.outputPlug,this.inputPlug,e,this.tree.camera)}},NodeGraph.ConnectionStyle.Linear=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n);t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.ZLinear=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n);t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x+25*n.zoomSmooth,i.y),t.lineTo(d.x-25*n.zoomSmooth,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.Bezier=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n);t.beginPath(),t.moveTo(i.x,i.y),t.bezierCurveTo(d.x,i.y,i.x,d.y,d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.SoftBezier=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=(i.x+d.x)/2;t.beginPath(),t.moveTo(i.x,i.y),t.bezierCurveTo(r,i.y,r,d.y,d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.BufferedBezier=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=25*n.zoomSmooth;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x+r,i.y),t.bezierCurveTo(d.x,i.y,i.x,d.y,d.x-r,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.BufferedSoftBezier=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=(i.x+d.x)/2,s=25*n.zoomSmooth;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(i.x+s,i.y),t.bezierCurveTo(r,i.y,r,d.y,d.x-s,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.Sharp=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=(i.x+d.x)/2;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r,i.y),t.lineTo(r,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.LateSharp=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=d.x-30*n.zoomSmooth;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r,i.y),t.lineTo(r,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.ConnectionStyle.EarlySharp=function(e,o,t,n){let i=e.pos.toScreen(n),d=o.pos.toScreen(n),r=i.x+30*n.zoomSmooth;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r,i.y),t.lineTo(r,d.y),t.lineTo(d.x,d.y),t.stroke()},NodeGraph.Input=class{constructor(e){this.node=e,this.settingHeight=24,this.settings=[]}addSetting(e){this.settings.push(e)}update(){let e=this.node.tree.camera,o=e.zoomSmooth,t=(this.node.width-20)*o,n=this.settingHeight*o,i=this.node.posSmooth.copy();i.shift(10,this.node.tree.theme.nodeHeaderSize+3),i=i.toScreen(this.node.tree.camera);let d={x:i.x,y:i.y,width:t,height:n};for(let e of this.settings)d.height=n*e.lineHeight,e.update(d,o),d.y+=e.lineHeight*n+3*o}render(e){let o=this.node.tree.camera,t=o.zoomSmooth,n=(this.node.width-20)*t,i=this.settingHeight*t,d=this.node.posSmooth.copy();d.shift(10,this.node.tree.theme.nodeHeaderSize+3),d=d.toScreen(o);let r={x:d.x,y:d.y,width:n,height:i};e.fillStyle=this.node.tree.theme.plugFontColor,e.font=this.node.tree.theme.plugFontSize*o.zoomSmooth+"px "+this.node.tree.theme.plugFontFamily,e.textBaseline="middle";for(let o of this.settings)r.height=i*o.lineHeight,o.drawName(e,r,i),r.y+=o.lineHeight*i+3*t}plugPositions(){let e={inputs:[],outputs:[]},o=this.node.posSmooth.copy();o.y+=this.node.tree.theme.nodeHeaderSize+3+this.settingHeight/2;let t=this.settingHeight,n=this.node.width;for(let i of this.settings)i.isOutput?e.outputs.push({x:o.x+n,y:o.y,plug:i.plug}):e.inputs.push({x:o.x,y:o.y,plug:i.plug}),o.y+=i.lineHeight*t+3;return e}get height(){let e=0;for(let o of this.settings)e+=o.lineHeight*this.settingHeight+3;return e}get minWidth(){let e=0;for(let o of this.settings)e=Math.max(e,o.minWidth);return e}get recommendedWidth(){let e=0;for(let o of this.settings)e=Math.max(e,o.recommendedWidth);return e}destroy(){for(let e of this.settings)e.destroy();this.settings=[]}setFocusable(e){for(let o of this.settings)o.setFocusable(e)}},NodeGraph.InputSetting=class{constructor(e,o,t,n){this.tree=e,this.name=o,this.lineHeight=1,this.minWidth=80,this.focusable=!0,this.isOutput=n,this.filled=!1,this.unfocusable=!1,this.hasTitle=!0,this.domType=t}buildDom(e){null!=this.dom&&document.body.removeChild(this.dom),this.dom=document.createElement(e),document.body.appendChild(this.dom),this.dom.classList.add("nodegraph-inputsetting"),this.dom.addEventListener("focus",o=>this.onFocus(o)),this.dom.addEventListener("mousedown",o=>this.onMouseDown(o)),this.dom.addEventListener("mousemove",o=>this.onMouseMove(o)),this.dom.addEventListener("mouseup",o=>this.onMouseUp(o)),this.dom.addEventListener("mousewheel",o=>this.onScroll(o),{passive:!0}),this.setFocusable(this.focusable),null==this.buildDomLate||this.filled||this.buildDomLate()}setFilled(e){this.filled=e,this.focusable=!e,this.filled?this.destroy():this.buildDom(this.domType),this.filled&&(this.lineHeight=1)}update(e,o){if(null==this.dom)return;if(this.hasName){e={x:e.x,y:e.y,width:e.width,height:e.height};let o=e.width/3;e.width-=o,e.x+=o}let t=this.tree.theme.plugFontSize*o;this.dom.style.top=e.y+"px",this.dom.style.left=e.x+"px",this.dom.style.width=e.width+"px",this.dom.style.height=e.height+"px",this.dom.style.fontSize=t+"px",this.dom.style.borderRadius=4*o+"px",this.dom.style.padding=3*o+"px",null!=this.updateLate&&this.updateLate(e,o)}setFocusable(e){this.unfocusable&&(e=!1),this.focusable=e,null!=this.dom&&(this.dom.style.pointerEvents=e?"auto":"none")}destroy(){null!=this.dom&&document.body.removeChild(this.dom)}onFocus(e){this.focusable||(e.preventDefault(),e.relatedTarget?e.relatedTarget.focus():e.currentTarget.blur())}onMouseDown(e){1==e.which||(e.preventDefault(),this.tree.onMouseDown(e))}onMouseMove(e){this.tree.onMouseMove(e)}onMouseUp(e){1==e.which||(e.preventDefault(),this.tree.onMouseUp(e))}onScroll(e){this.tree.onScroll(e)}drawName(e,o,t){if(this.hasName){let n=o.y+t/2;this.isOutput?(e.textAlign="right",e.fillText(this.name,o.x+o.width,n)):(e.textAlign="left",e.fillText(this.name,o.x,n))}}get recommendedWidth(){var e=Math.max;let o=this.tree.canvas,t=o.getContext("2d");t.save(),t.font=this.tree.theme.plugFontSize*this.tree.camera.zoomSmooth+"px "+this.tree.theme.plugFontFamily;let n=t.measureText(this.name).width+20;return t.restore(),e(3*n,3*(this.minWidth/2))}get hasName(){return!(null!=this.dom)||!this.isOutput}},NodeGraph.TextInputSetting=class extends NodeGraph.InputSetting{constructor(e,o){super(e,o,"input",!1),this.minWidth=150,this.hasTitle=!1,this.buildDom(this.domType)}buildDomLate(){this.dom.setAttribute("type","text")}},NodeGraph.TextBlockSetting=class extends NodeGraph.InputSetting{constructor(e,o,t){super(e,o,"textarea",!1),this.rows=t,this.minWidth=200,this.buildDom(this.domType)}buildDomLate(){this.lineHeight=this.rows,this.dom.rows=this.rows,this.dom.style.resize="none"}},NodeGraph.PlainTextSetting=class extends NodeGraph.InputSetting{constructor(e,o,t){super(e,o,null,t)}},NodeGraph.ColorSetting=class extends NodeGraph.InputSetting{constructor(e,o,t="#FFFFFF"){super(e,o,"input",!1),this.value=t,this.buildDom(this.domType)}buildDomLate(){this.dom.setAttribute("type","color"),this.dom.setAttribute("value",this.value)}},NodeGraph.RangeSetting=class extends NodeGraph.InputSetting{constructor(e,o,t=0,n=1,i=1,d=1){super(e,o,"input",!1),this.min=t,this.max=n,this.step=d,this.value=i,this.buildDom(this.domType)}buildDomLate(){this.dom.setAttribute("type","range"),this.dom.setAttribute("min",this.min),this.dom.setAttribute("max",this.max),this.dom.setAttribute("step",this.step),this.dom.setAttribute("value",this.value)}updateLate(e,o){let t=document.getElementsByTagName("html")[0];t.style.cssText="--nodegraph-sliderSize: "+25*o+"px"}},NodeGraph.DropdownSetting=class extends NodeGraph.InputSetting{constructor(e,o,t=[]){super(e,o,"select",!1),this.options=t,this.buildDom(this.domType)}buildDomLate(){for(let e of this.options){let o=document.createElement("option");this.dom.appendChild(o),o.innerHTML=e}}},NodeGraph.CheckboxSetting=class extends NodeGraph.InputSetting{constructor(e,o,t=!1){super(e,o,"input",!1),this.value=t,this.minWidth=30,this.buildDom(this.domType)}buildDomLate(){this.dom.setAttribute("type","checkbox")}updateLate(e,o){let t=16*o;this.dom.style.top=e.y+"px",this.dom.style.left=e.x+"px",this.dom.style.width=t+"px",this.dom.style.height=t+"px"}},NodeGraph.Node=class{constructor(e,o,t=null,n="Node"){var i=Math.round,d=Math.max;if(this.tree=e,this.name=n,this.id=NodeGraph.Utils.randomGuid(),this.type=t,this._width=0,this._height=0,this.position=o,this.posSmooth=o.copy(),this.snapPos=o.copy(),this.inputPlugs=[],this.outputPlugs=[],this.input=new NodeGraph.Input(this),this.dragging=!1,this.resizing=!1,this.resizeDir=null,this.hover=!1,this.select=!1,e.theme.hasGridBehavior){let o=e.theme.gridSize;this.position.x=i(this.position.x/o)*o,this.position.y=i(this.position.y/o)*o,this.posSmooth.setFrom(this.position),this.snapPos.setFrom(this.position)}null!=t&&(null!=t.name&&(this.name=t.name),null!=t.onInit&&t.onInit(this)),this._width=d(this.width,this.input.recommendedWidth)}parents(){let e=[],o=this;return tree.findConnections({node2:o}).forEach(o=>{-1==e.indexOf(o.outputPlug.node)&&e.push(o.outputPlug.node)}),e}children(){let e=[],o=this;return tree.findConnections({node1:o}).forEach(o=>{-1==e.indexOf(o.inputPlug.node)&&e.push(o.inputPlug.node)}),e}isAncestorOf(e){if(this===e)return!0;let o=this.children();for(let t=0;t<o.length;t++)if(o[t].isAncestorOf(e))return!0;return!1}update(e,o){e/=this.tree.theme.nodeSmoothing,this.dragging?this.posSmooth.lerpTo(this.snapPos,e):this.posSmooth.lerpTo(this.position,e),this.input.update()}needsUpdate(){return 1<this.position.toScreen(this.tree.camera).distanceSquared(this.posSmooth.toScreen(this.tree.camera))}addInput(e="",o=null){let t=new NodeGraph.Plug(this,!0,e,o);return this.inputPlugs.push(t),this.tree.repaint=!0,t}addOutput(e="",o=null){let t=new NodeGraph.Plug(this,!1,e,o);return this.outputPlugs.push(t),this.tree.repaint=!0,t}get width(){let e=Math.max(this._width,this.minWidth);if(this.tree.theme.hasGridBehavior){let o=this.tree.theme.gridSize;e=Math.ceil(e/o)*o}return e}get minWidth(){var e=Math.max;let o=e(this.tree.theme.nodeMinWidth,this.input.minWidth),t=0;{let e=this.tree.canvas,o=e.getContext("2d");o.save(),o.font=this.tree.theme.headerFontSize+"px "+this.tree.theme.headerFontFamily,t=o.measureText(this.name).width+20,o.restore()}return e(o,t)}get height(){let e=Math.max(this._height,this.minHeight);if(this.tree.theme.hasGridBehavior){let o=this.tree.theme.gridSize;e=Math.ceil(e/o)*o}return e}get minHeight(){return Math.max(this.tree.theme.nodeMinHeight,this.tree.theme.nodeHeaderSize+this.input.height)+3}get nodeColor(){return null==this._nodeColor?this.tree.theme.nodeColor:this._nodeColor}set nodeColor(e){this._nodeColor=e}get nodeHeaderColor(){return null==this._nodeHeaderColor?this.tree.theme.nodeHeaderColor:this._nodeHeaderColor}set nodeHeaderColor(e){this._nodeHeaderColor=e}get borderColor(){return null==this._borderColor?this.tree.theme.nodeBorderColor:this._nodeBorderColor}set borderColor(e){this._nodeBorderColor=e}get borderColorHighlight(){return null==this._borderColorHighlight?this.tree.theme.nodeBorderHighlight:this._nodeBorderColorHighlight}set borderColorHighlight(e){this._nodeBorderColorHighlight=e}render(e){let o=this.tree.camera,t=o.zoomSmooth,n=this.posSmooth.toScreen(o),i=this.width*t,d=this.height*t,r=this.tree.theme.nodeBorderRadius*t,s=this.tree.theme.nodeHeaderSize*t;this.buildNodeShape(e,n,i,d,r),e.fillStyle=this.nodeColor,e.fill(),this.buildNodeHeaderShape(e,n,i,d,r,s),e.fillStyle=this.nodeHeaderColor,e.fill(),this.buildNodeShape(e,n,i,d,r),e.lineWidth=this.tree.theme.nodeBorderThickness*t,e.strokeStyle=this.select?this.tree.theme.nodeBorderSelect:this.hover?this.borderColorHighlight:this.borderColor,e.stroke();for(let o=0;o<this.inputPlugs.length;o++)this.inputPlugs[o].render(e);for(let o=0;o<this.outputPlugs.length;o++)this.outputPlugs[o].render(e);e.fillStyle=this.tree.theme.headerFontColor,e.font=this.tree.theme.headerFontSize*t+"px "+this.tree.theme.headerFontFamily,e.textAlign="center",e.textBaseline="middle",e.fillText(this.name,n.x+i/2,n.y+1.05*(s/2)),this.input.render(e)}buildNodeShape(e,o,t,n,i){e.beginPath(),e.moveTo(o.x+i,o.y),e.lineTo(o.x+t-i,o.y),e.quadraticCurveTo(o.x+t,o.y,o.x+t,o.y+i),e.lineTo(o.x+t,o.y+n-i),e.quadraticCurveTo(o.x+t,o.y+n,o.x+t-i,o.y+n),e.lineTo(o.x+i,o.y+n),e.quadraticCurveTo(o.x,o.y+n,o.x,o.y+n-i),e.lineTo(o.x,o.y+i),e.quadraticCurveTo(o.x,o.y,o.x+i,o.y),e.closePath()}buildNodeHeaderShape(e,o,t,n,i,d){e.beginPath(),e.moveTo(o.x+i,o.y),e.lineTo(o.x+t-i,o.y),e.quadraticCurveTo(o.x+t,o.y,o.x+t,o.y+i),e.lineTo(o.x+t,o.y+d),e.lineTo(o.x,o.y+d),e.lineTo(o.x,o.y+i),e.quadraticCurveTo(o.x,o.y,o.x+i,o.y),e.closePath()}isInBounds(e,o,t=5){let n=this.tree.camera,i=n.zoomSmooth,d=this.posSmooth.toScreen(n),r=this.width*i,s=this.height*i;return e>=d.x-t&&e<d.x+r+t&&o>=d.y-t&&o<d.y+s+t}getResizeDir(e,o,t=5){let n=this.tree.camera,i=n.zoomSmooth,d=this.posSmooth.toScreen(n),r=this.width*i,s=this.height*i;if(e<d.x-t||e>d.x+r+t||o<d.y-t||o>d.y+s+t)return"none";if(e>d.x+t&&e<d.x+r-t&&o>d.y+t&&o<d.y+s-t)return"none";let a=!1;if(this.forEachPlug(t=>a|=t.isInBounds(e,o)),a)return"none";let l=o>d.y-t&&o<d.y+t,p=e>d.x+r-t&&e<d.x+r+t,u=o>d.y+s-t&&o<d.y+s+t,m=e>d.x-t&&e<d.x+t;return!l||p||u||m?l&&p&&!u&&!m?"ne-resize":l&&!p&&!u&&m?"nw-resize":l||!p||u||m?l||p||!u||m?!l&&p&&u&&!m?"se-resize":!l&&!p&&u&&m?"sw-resize":l||p||u||!m?"none":"w-resize":"s-resize":"e-resize":"n-resize"}applyResize(e,o){var t=Math.min,n=Math.max;switch(this._height=n(this.minHeight,this._height),this._width=n(this.minWidth,this._width),this.resizeDir){case"n-resize":o=t(o,this._height-this.minHeight),this.position.y+=o,this.snapPos.y+=o,this.posSmooth.y+=o,this._height-=o;break;case"ne-resize":o=t(o,this._height-this.minHeight),this.position.y+=o,this.snapPos.y+=o,this.posSmooth.y+=o,this._width+=e,this._height-=o;break;case"nw-resize":e=t(e,this._width-this.minWidth),o=t(o,this._height-this.minHeight),this.position.x+=e,this.snapPos.x+=e,this.posSmooth.x+=e,this.position.y+=o,this.snapPos.y+=o,this.posSmooth.y+=o,this._width-=e,this._height-=o;break;case"e-resize":this._width+=e;break;case"s-resize":this._height+=o;break;case"se-resize":this._width+=e,this._height+=o;break;case"sw-resize":e=t(e,this._width-this.minWidth),this.position.x+=e,this.snapPos.x+=e,this.posSmooth.x+=e,this._width-=e,this._height+=o;break;case"w-resize":e=t(e,this._width-this.minWidth),this.position.x+=e,this.snapPos.x+=e,this.posSmooth.x+=e,this._width-=e;}}forEachPlug(e){this.inputPlugs.forEach(e),this.outputPlugs.forEach(e)}destroy(){this.input.destroy()}},NodeGraph.Plug=class{constructor(e,o,t="",n=null){this.node=e,this.isInput=o,this.name=t,this.type=n,this.hover=!1,this.setting=null!=n&&null!=n.createSetting&&o?n.createSetting(this):new NodeGraph.PlainTextSetting(e.tree,this.name,!o),this.node.input.addSetting(this.setting),this.setting.plug=this}canConnectTo(e){return!!this.canReplaceConnection(e)&&!(0<this.node.tree.findConnections({inputPlug:e}).length)}canReplaceConnection(e){return this.isInput!=e.isInput&&(this.isInput?e.canConnectTo(this):!(this.node.tree!==e.node.tree)&&!e.node.isAncestorOf(this.node)&&!!(null==this.type||null==e.type||this.type.canConnectTo(e.type)))}get plugColor(){return null==this.type||null==this.type.plugColor?this.node.tree.theme.plugColor:this.type.plugColor}get plugBorderColor(){return null==this.type||null==this.type.plugBorderColor?this.node.tree.theme.plugBorderColor:this.type.plugBorderColor}get plugBorderHighlight(){return null==this.type||null==this.type.plugBorderHighlight?this.node.tree.theme.plugBorderHighlight:this.type.plugBorderHighlight}get x(){return null==this._x?this.node.input.plugPositions()[this.isInput?"inputs":"outputs"].filter(e=>e.plug===this)[0].x:this._x}get y(){return null==this._y?this.node.input.plugPositions()[this.isInput?"inputs":"outputs"].filter(e=>e.plug===this)[0].y:this._y}get pos(){return new NodeGraph.Position(this.x,this.y)}isInBounds(e,o){let t=this.node.tree.theme.plugRadius;return t=t*t*this.node.tree.camera.zoomSmooth,this.pos.toScreen(this.node.tree.camera).distanceSquared(new NodeGraph.Position(e,o))<t}render(e){let o=this.node.tree.camera.zoomSmooth,t=this.node.tree.theme.plugRadius*o,n=this.node.tree.theme.plugBorderSize*o,i=this.pos.toScreen(this.node.tree.camera);e.beginPath(),e.arc(i.x,i.y,t,2*Math.PI,!1),e.fillStyle=this.plugColor,e.fill(),e.strokeStyle=this.hover?this.plugBorderHighlight:this.plugBorderColor,e.lineWidth=n,e.stroke()}},NodeGraph.PopupObject=class{constructor(e,o,t,n){this.element1=o,this.element2=t,this.menu=n,this._text=o.innerHTML,this._tooltip=t.innerHTML,this.warnings=[],this._greyedOut=!1,this.element1.onclick=o=>{null!=this.onclick&&this.onclick(o),e.popuptext.classList.toggle("nodegraph-show",!1)}}get text(){return this._text}set text(e){this._text=e,this.element1.innerHTML=e}get tooltip(){return this._tooltip}set tooltip(e){this._tooltip=e,this.updateTooltip()}get greyedOut(){return this._greyedOut}set greyedOut(e){this._greyedOut=e,this.element1.classList.toggle("nodegraph-greyout",e)}clearTooltipWarnings(){this.warnings=[],this.updateTooltip()}addTooltipWarning(e){this.warnings.push(e),this.updateTooltip()}updateTooltip(){let e=this._tooltip;for(let o=0;o<this.warnings.length;o++)0==o&&(e+="<br>"),e+="<br>* "+this.warnings[o];this.element2.innerHTML=e}},NodeGraph.Position=class{constructor(e,o,t=!0){this.x=e,this.y=o,this.worldSpace=t}toWorld(e){let o=new NodeGraph.Position(this.x,this.y);return this.worldSpace||(o.x=(o.x+e.xSmooth)/e.zoomSmooth,o.y=(o.y+e.ySmooth)/e.zoomSmooth),o}toScreen(e){let o=new NodeGraph.Position(this.x,this.y);return this.worldSpace&&(o.x=o.x*e.zoomSmooth-e.xSmooth,o.y=o.y*e.zoomSmooth-e.ySmooth),o}copy(){return new NodeGraph.Position(this.x,this.y,this.worldSpace)}lerpTo(e,o){if(this.worldSpace!=e.worldSpace)throw"Cannot lerp to position in different space!";this.x=NodeGraph.Utils.lerp(this.x,e.x,o),this.y=NodeGraph.Utils.lerp(this.y,e.y,o)}distanceTo(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){if(this.worldSpace!=e.worldSpace)throw"Cannot get distance to position in different space!";let o=this.x-e.x,t=this.y-e.y;return o*o+t*t}setFrom(e){this.x=e.x,this.y=e.y,this.worldSpace=e.worldSpace}shift(e,o){this.x+=e,this.y+=o}setTo(e,o){this.x=e,this.y=o}},NodeGraph.Theme=class{constructor(){this.cameraSmoothing=.08,this.nodeSmoothing=.03,this.headerFontSize=20,this.plugFontSize=16,this.headerFontFamily="Calibri",this.plugFontFamily="Calibri",this.headerFontColor="#CCCCCC",this.plugFontColor="#AAAAAA",this.nodeMinWidth=100,this.nodeMinHeight=50,this.connectionWidth=2,this.connectionColor="#FF7F50",this.connectionStyle=NodeGraph.ConnectionStyle.SoftBezier,this.plugRadius=8,this.plugBorderSize=1.5,this.plugColor="#777777",this.plugBorderColor="#555555",this.plugBorderHighlight="#999999",this.backgroundColor="#121212",this.nodeColor="#552222",this.nodeBorderColor="#555555",this.nodeBorderHighlight="#777777",this.nodeBorderSelect="#999955",this.nodeHeaderColor="#441111",this.nodeHeaderSize=37,this.nodeBorderThickness=2,this.nodeBorderRadius=8,this.gridSize=50,this.gridRenderOnly=!0,this.gridMajorSegments=4,this.gridColor="#242424",this.gridMajorColor="#363636",this.gridMinRenderSize=25,this.gridMaxRenderSize=100}get shouldRenderGrid(){return 0<this.gridSize}get hasGridBehavior(){return 0<this.gridSize&&!this.gridRenderOnly}get hasMajorGrid(){return this.shouldRenderGrid&&0<this.gridMajorSegments}get shouldZoomInGrid(){return this.hasMajorGrid&&0<this.gridMaxRenderSize}get shouldZoomOutGrid(){return this.hasMajorGrid&&0<this.gridMinRenderSize}},NodeGraph.Tree=class{constructor(e,o){this.canvas=e,this.theme=o,this.canvasWidth=e.clientWidth,this.canvasHeight=e.clientHeight,this.nodes=[],this.connections=[],this.camera=new NodeGraph.Camera(o),this.tempConnectionPlug=new NodeGraph.Node(this,new NodeGraph.Position(0,0)).addInput(),this.tempConnection=null,this.lastFrame=0,this.repaint=!0,this.alive=!0,e.tabIndex="1",e.addEventListener("mousedown",o=>this.onMouseDown(o)),e.addEventListener("mousemove",o=>this.onMouseMove(o)),e.addEventListener("mouseup",o=>this.onMouseUp(o)),e.addEventListener("keyup",o=>this.onKeyUp(o)),e.addEventListener("contextmenu",o=>this.onContextMenu(o),!1),e.addEventListener("mousewheel",o=>this.onScroll(o)),this.buildPopup(),requestAnimationFrame(e=>this.animation(e))}buildPopup(){let e=document.createElement("div");e.classList.add("nodegraph-popup"),document.body.appendChild(e),this.popuptext=document.createElement("span"),this.popuptext.classList.add("nodegraph-popuptext"),e.appendChild(this.popuptext),this.popuptext.empty=this.addPopupOption("Empty","",null,!0),this.popuptext.empty.greyedOut=!0}addPopupOption(e,o,t=null,n=!1){null==t&&(t=this.popuptext),n||null==t.empty||(this.removePopupOption(t.empty,!0),t.empty=null);let i=document.createElement("div");i.innerHTML=e,i.unselectable="on",i.classList.add("nodegraph-unselectable"),i.classList.add("nodegraph-menuoption"),t.appendChild(i);let d=document.createElement("div");d.innerHTML=o,d.unselectable="on",d.classList.add("nodegraph-unselectable"),d.classList.add("nodegraph-tooltip"),t.appendChild(d);let r=new NodeGraph.PopupObject(this,i,d,t);return r}removePopupOption(e,o=!1){e.menu.removeChild(e.element1),e.menu.removeChild(e.element2),o||0!=e.menu.childElementCount||(e.menu.empty=this.addPopupOption("Empty","",e.menu,!0),e.menu.empty.greyedOut=!0)}createContextSubmenu(e,o=null){null==o&&(o=this.popuptext),null!=o.empty&&(this.removePopupOption(o.empty,!0),o.empty=null);let t=document.createElement("div");t.innerHTML=e,t.unselectable="on",t.classList.add("nodegraph-unselectable"),t.classList.add("nodegraph-menuoption"),o.appendChild(t);let n=document.createElement("div");n.unselectable="on",n.classList.add("nodegraph-unselectable"),n.classList.add("nodegraph-menuArrow"),t.appendChild(n);let i=document.createElement("div");return i.classList.add("nodegraph-submenu"),o.appendChild(i),i.empty=this.addPopupOption("Empty","",i,!0),i.empty.greyedOut=!0,i}animation(e){let o=(e-this.lastFrame)/1e3;this.lastFrame=e,this.needsUpdate()&&this.update(o),this.alive&&requestAnimationFrame(e=>this.animation(e))}getNodeById(e){for(let o=0;o<this.nodes.length;o++)if(this.nodes[o].id==e)return this.nodes[o];return null}addNode(e=new NodeGraph.Position(0,0),o=null,t="Node"){let n=new NodeGraph.Node(this,e,o,t);return this.nodes.push(n),this.repaint=!0,n}addConnection(e,o){let t=new NodeGraph.Connection(this,e,o);if(!this.contains(e.node))throw"Connection exists outside of tree!";return this.connections.push(t),this.repaint=!0,o.setting.setFilled(!0),t}contains(e){return e instanceof NodeGraph.Connection?-1!=this.connections.indexOf(connection):-1!=this.nodes.indexOf(e)}removeNode(e){let o=this.nodes.indexOf(e);if(-1!=o){for(let o=0;o<this.connections.length;o++)(this.connections[o].outputPlug.node===e||this.connections[o].inputPlug.node===e)&&(this.removeConnection(this.connections[o]),o--);this.nodes.splice(o,1),e.destroy(),this.repaint=!0}}removeConnection(e){let o=this.connections.indexOf(e);-1==o||(this.connections.splice(o,1),e.inputPlug.setting.setFilled(!1),this.repaint=!0)}update(e){this.repaint=!1,this.camera.update(e);for(let o=0;o<this.nodes.length;o++)this.nodes[o].update(e);this.render()}render(){let e=this.canvas.getContext("2d");this.renderBackground(e);for(let o=0;o<this.connections.length;o++)this.connections[o].render(e);for(let o=0;o<this.nodes.length;o++)this.nodes[o].render(e);null!=this.tempConnection&&this.tempConnection.render(e)}renderBackground(e){this.canvasWidth=this.canvas.clientWidth,this.canvasHeight=this.canvas.clientHeight;let o=this.canvas.width=this.canvasWidth,t=this.canvas.height=this.canvasHeight;if(e.fillStyle=this.theme.backgroundColor,e.fillRect(0,0,o,t),!this.theme.shouldRenderGrid)return;let n=new NodeGraph.Position(0,0,!1);n=n.toWorld(this.camera);let i=new NodeGraph.Position(o,t,!1);i=i.toWorld(this.camera);let d=this.theme.gridSize;if(this.theme.shouldZoomOutGrid)for(;this.camera.zoomSmooth*d<this.theme.gridMinRenderSize;)d*=this.theme.gridMajorSegments;if(this.theme.shouldZoomInGrid)for(;this.camera.zoomSmooth*d>this.theme.gridMaxRenderSize;)d/=this.theme.gridMajorSegments;e.lineWidth=1,e.strokeStyle=this.theme.gridColor,this.renderGrid(e,n,i,d,o,t),this.theme.hasMajorGrid&&(d*=this.theme.gridMajorSegments,e.strokeStyle=this.theme.gridMajorColor,this.renderGrid(e,n,i,d,o,t))}renderGrid(e,o,t,n,i,d){var r=Math.ceil;let s=r(o.x/n)*n,a=r(t.x/n)*n,l=r(o.y/n)*n,p=r(t.y/n)*n;for(let r=s;r<a;r+=n)e.beginPath(),e.moveTo(this.camera.camX(r),0),e.lineTo(this.camera.camX(r),d),e.closePath(),e.stroke();for(let r=l;r<p;r+=n)e.beginPath(),e.moveTo(0,this.camera.camY(r)),e.lineTo(i,this.camera.camY(r)),e.closePath(),e.stroke()}needsUpdate(){if(this.repaint)return!0;if(this.canvas.clientWidth!=this.canvasWidth||this.canvasHeight!=this.canvasHeight)return!0;if(this.camera.needsUpdate())return!0;for(let e=0;e<this.nodes.length;e++)if(this.nodes[e].needsUpdate())return!0;return!1}findConnections({node1:e=null,node2:o=null,outputPlug:t=null,inputPlug:n=null}){let d=[];for(let r,s=0;s<this.connections.length;s++)r=this.connections[s],null!=e&&r.outputPlug.node!==e||null!=o&&r.inputPlug.node!==o||null!=t&&r.outputPlug!==t||null!=n&&r.inputPlug!==n||d.push(r);return d}onMouseDown(e){3!=e.which&&this.popuptext.classList.toggle("nodegraph-show",!1),this.nodes.forEach(e=>e.input.setFocusable(!1));let o=e.clientX,t=e.clientY;if(this.lastMouseX=o,this.lastMouseY=t,this.cameraDrag=!1,this.firstMove=!0,this.resizing=!1,this.mouseDownTime=new Date().getTime(),this.nodes.forEach(e=>e.dragging=e.resizing=!1),1!=e.which)2==e.which&&(this.cameraDrag=!0);else if(this.mouseDown=!0,!e.shiftKey){let e=null;this.nodes.forEach(n=>{n.isInBounds(o,t)&&(e=n)}),null==e?(this.nodes.forEach(e=>e.select=!1),this.repaint=!0):(this.nodes.forEach(e=>e.select=!1),e.select=!0,e.resizeDir=e.getResizeDir(o,t),"none"!=e.resizeDir&&(e.resizing=!0,this.resizing=!0),this.nodes.splice(this.nodes.indexOf(e),1),this.nodes.push(e),this.repaint=!0)}}onMouseMove(e){var o=Math.round;let t=e.clientX,n=e.clientY,i=null;if(this.nodes.forEach(e=>{let o=e.isInBounds(t,n);e.forEachPlug(e=>{let d=e.isInBounds(t,n);d&&(i=e),d!=e.hover&&(e.hover=d,this.repaint=!0),d&&(o=!0)}),o!=e.hover&&(e.hover=o,this.repaint=!0)}),this.mouseDown){if(null!=i&&this.firstMove)if(i.isInput){let e=this.findConnections({inputPlug:i});if(0<e.length){let o=e[0];this.removeConnection(o),this.tempConnection=new NodeGraph.Connection(this,o.outputPlug,this.tempConnectionPlug)}}else this.tempConnection=new NodeGraph.Connection(this,i,this.tempConnectionPlug);let e=this.theme.hasGridBehavior,d=this.theme.gridSize;if(null!=this.tempConnection)this.tempConnectionPlug._x=this.camera.acamX(t),this.tempConnectionPlug._y=this.camera.acamY(n),null!=i&&(this.tempConnectionPlug._x=i.x,this.tempConnectionPlug._y=i.y),this.repaint=!0;else{let i=(t-this.lastMouseX)/this.camera.zoomSmooth,r=(n-this.lastMouseY)/this.camera.zoomSmooth;this.resizing?this.nodes.forEach(e=>{e.resizing&&(e.applyResize(i,r),this.repaint=!0)}):this.nodes.forEach(t=>{t.select&&(t.dragging=!0,t.position.x+=i,t.position.y+=r,e?(t.snapPos.x=o(t.position.x/d)*d,t.snapPos.y=o(t.position.y/d)*d):t.snapPos.setFrom(t.position))})}}if(this.cameraDrag&&(this.camera.x-=t-this.lastMouseX,this.camera.y-=n-this.lastMouseY),!this.mouseDown&&!this.cameraDrag){let e="auto";this.nodes.forEach(o=>{let i=o.getResizeDir(t,n);"none"!=i&&(e=i)}),this.canvas.style.cursor=e}this.lastMouseX=t,this.lastMouseY=n,this.firstMove=!1}onMouseUp(e){this.nodes.forEach(e=>e.input.setFocusable(!0));let o=e.clientX,t=e.clientY;this.mouseDown=!1,this.cameraDrag=!1,this.resizing=!1,this.justClicked=null;let n=new Date().getTime()-this.mouseDownTime;if(200>=n&&this.onClick(e),null!=this.tempConnection){let e=null;if(this.nodes.forEach(n=>{n.forEachPlug(n=>{let i=n.isInBounds(o,t);i&&(e=n)})}),null!=e&&this.tempConnection.outputPlug.canReplaceConnection(e)){let o=this.findConnections({inputPlug:e});0<o.length&&this.removeConnection(o[0]),this.addConnection(this.tempConnection.outputPlug,e)}this.tempConnection=null,this.repaint=!0}this.nodes.forEach(e=>{e.dragging=!1,e.position.setFrom(e.snapPos)})}onClick(e){let o=e.clientX,t=e.clientY,n=null;this.nodes.forEach(e=>{e.isInBounds(o,t)&&(n=e)}),null==n?!e.shiftKey&&(this.nodes.forEach(e=>e.select=!1),this.repaint=!0):e.shiftKey?(n.select=!n.select,this.nodes.splice(this.nodes.indexOf(n),1),this.nodes.push(n),this.repaint=!0):(this.nodes.forEach(e=>e.select=!1),n.select=!0,this.repaint=!0,this.nodes.splice(this.nodes.indexOf(n),1),this.nodes.push(n))}onMouseExit(e){this.mouseDown=!1,this.cameraDrag=!1,this.nodes.forEach(e=>{e.dragging=!1,e.hover&&(e.hover=!1,this.repaint=!0),e.forEachPlug(e=>{e.hover&&(e.hover=!1,this.repaint=!0)})})}onScroll(e){var o=Math.pow;let t=0;if(e||(e=window.event),e.wheelDelta?t=e.wheelDelta/60:e.detail&&(t=-e.detail/2),0==t)return;let n=e.clientX,i=e.clientY,d=(n+this.camera.x)/this.camera.zoom,r=(i+this.camera.y)/this.camera.zoom;0>t?.2<this.camera.zoom&&(this.camera.zoom*=o(.92,-t)):5>this.camera.zoom&&(this.camera.zoom*=o(1/.92,t)),this.camera.x=d*this.camera.zoom-n,this.camera.y=r*this.camera.zoom-i,this.repaint=!0,e.preventDefault()}onContextMenu(e){this.popuptext.classList.toggle("nodegraph-show");let o=this.popuptext.parentElement;o.style.left=e.clientX+"px",o.style.top=e.clientY+"px",this.onMouseDown(e),this.onMouseUp(e),e.preventDefault()}onKeyUp(e){if(46==e.keyCode){let e=[];this.nodes.forEach(o=>{o.select&&e.push(o)});for(let o of e)this.removeNode(o)}}destroy(){this.nodes.forEach(e=>e.destroy()),this.nodes=[],this.connections=[],this.alive=!1,document.body.removeChild(this.popuptext.parentElement)}},NodeGraph.Utils.lerp=function(e,o,n){return 0>=n?e:1<=n?o:e*(1-n)+o*n},NodeGraph.Utils.randomGuid=function(){var e=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()};